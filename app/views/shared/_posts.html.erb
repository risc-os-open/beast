<%#
  Renders a standardised table of paginated Posts based on the following
  local variables passed into the Partial:

  +posts+::       The set of Posts to render, as an ActiveRecord::Relation.
                  Eager loading of User, Forum and Topic is recommended!

  +pagy+::        The Pagy object to use to paginate the collection in +posts+.

  +embed_topic+:: If +true+, information on the topic and forum of each post
                  will be embedded above each post body area; this is needed
                  if posts in the collection come from multiple topics.
                  Otherwise, pass +false+ for a cleaner view.
%>

<table border="0" cellspacing="0" cellpadding="4" class="posts collapsible">
  <tbody>
    <% for post in @posts do %>
      <% user = post.user || User.new(id: 0, email: 'webmaster@riscosopen.org', display_name: 'Unknown') %>

      <% unless post == @posts.first %>
        <tr class="spacer">
          <td colspan="2">&nbsp;</td>
        </tr>
      <% end %>

      <tr class="post hentry" id="<%= post.dom_id %>">
        <td class="author">
          <%= avatar_for(user) %>

          <div class="date">
            <abbr class="updated" title="<%= post.created_at.xmlschema %>">
              <%= apphelp_creation_time_in_london(post) %>
            </abbr>
          </div>

          <span class="fn">
            <%= user.id.zero? ? user.display_name : apphelp_linked_name(user) %>
          </span>

          <span class="posts">
            (<%= pluralize post.user.posts_count, 'post' %>)
          </span>

          <% if logged_in? && post.editable_by?(current_user) %>
            <div class="edit">
              <%=
                link_to(
                  'Edit post',
                  edit_forum_topic_post_path(
                    id:       post,
                    forum_id: post.forum,
                    topic_id: post.topic,
                    page:     pagy.page,
                    limit:    pagy.limit
                  ),
                  class: 'utility'
                )
              %>
            </div>
          <% end %>
        </td>

        <td class="body">
          <% if embed_topic %>
            <p class="topic">
              Topic: <%= link_to(post.forum.name, forum_path(post.forum_id)) %> /
              <%= link_to(post.topic.title, forum_topic_path(forum_id: post.forum_id, id: post.topic_id)) %>
            </p>
          <% end %>

          <%= post.body_html.html_safe() %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
